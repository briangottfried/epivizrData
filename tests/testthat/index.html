<!DOCTYPE html>
<html>

<head>
<title>EpivizServer Test Page</title>

<style type="text/css">
  body { font-family: Helvetica; }
  pre { margin: 0 }
</style>

<script>
  
  var ws = new WebSocket("ws://" + window.location.host);
  var _measurements = {};
  
  function _update_msDiv(div_id) {
    var out = new Array();
    for (ms_id in _measurements) {
      if (!_measurements.hasOwnProperty(ms_id)) {
        continue;
      }
      var ms = _measurements[ms_id];
      out.push(ms.datasourceId + ":" + ms.id);
    }
    document.getElementById(div_id).innerHTML = out.toString();
  }
  
  function _addMeasurements(message_data, div_id) {
    var measurements = JSON.parse(message_data.measurements);

    for (var i = 0; i < measurements.length; i++) {
      var ms = measurements[i];
      _measurements[ms.id] = ms;  
    }
    
    _update_msDiv(div_id);
    
    response_data = {
      message: "This is a response from addMeasurements",
    }
    return response_data;
  }
  
  function _rmMeasurements(message_data, div_id) {
    var measurements = JSON.parse(message_data.measurements);
    for (var i = 0; i < measurements.length; i++) {
      var ms = measurements[i];
      delete _measurements[ms.id];
    }
    
    _update_msDiv(div_id);
    
    response_data = {
      message: "This is a response from removeMeasurements",
    }
    
    return response_data;
  }
  
  function _getMeasurements() {
    request = {
      type: "request",
      requestId: 1,
      data: {action: "getMeasurements"}
    }
    ws.send(JSON.stringify(request));
  }
  
  function _clearCache(request_data) {
    var datasource_id = request_data.datasourceGroup;
    document.getElementById("clear_cache_output").innerHTML = datasource_id + " cache cleared."
    response_data = {
      message: "This is a response from clearCache",
    }
    return response_data;
  }
  
  ws.onmessage = function(msg) {
    var message = JSON.parse(msg.data);
    console.dir(message);
    var type = message.type;
    var requestId = message.requestId;
    var message_data = message.data;
    
    if (type == "response") {
      var success = message.success;
      if (success) {
        _addMeasurements(message_data, "get_measurements_output");
      }
      else { console.log("response returned with success=false");}
    } else if (type == "request") {
      var action = message_data.action;

      var response_data; 
      switch(action) {
        case "addMeasurements":
          response_data = _addMeasurements(message_data, "add_measurements_output");
          break;
        case "removeMeasurements":
          response_data = _rmMeasurements(message_data, "add_measurements_output");
          break;
        case "clearDatasourceGroupCache":
          response_data = _clearCache(message_data);
          break;
      }
      
      response = {
        type: "response", 
        requestId: requestId, 
        success: true, 
        data: response_data
      };
      ws.send(JSON.stringify(response));
    }
  }
</script>
</head>

<body>
  <h3>Add Measurements</h3>
  <div id="add_measurements_output"></div>
  <h3>Get Measurements</h3>
  <button onclick="_getMeasurements()" id="get_measurements_btn">Get Measurements</button>
  <div id="get_measurements_output"></div>
  <div id="clear_cache_output"></div>
</body>
</html>

