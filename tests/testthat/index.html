<!DOCTYPE html>
<html>

<head>
<title>EpivizServer Test Page</title>

<style type="text/css">
  body { font-family: Helvetica; }
  pre { margin: 0 }
</style>

<script>
  
  var ws = new WebSocket("ws://" + window.location.host);
  var _measurements = {};
  
  function _update_msDiv() {
    var out = new Array();
    for (ms_id in _measurements) {
      if (!_measurements.hasOwnProperty(ms_id)) {
        continue;
      }
      var ms = _measurements[ms_id];
      out.push(ms.datasourceId + ": " + ms.id);
    }
    document.getElementById("measurements_output").innerHTML = out.toString();
  }
  
  function _addMeasurements(message_data) {
    var measurements = JSON.parse(message_data.measurements);

    for (var i = 0; i < measurements.length; i++) {
      var ms = measurements[i];
      _measurements[ms.id] = ms;  
    }
    
    _update_msDiv();
    
    response_data = {
      message: "This is a response",
    }
    return response_data;
  }
  
  ws.onmessage = function(msg) {
    var message = JSON.parse(msg.data);
    console.dir(message);
    var type = message.type;
    if (type == "response") {
      var success = message.success;
      if (success) {
      }
      else { console.log("response returned with success=false");}
    } else if (type == "request") {
      var requestId = message.requestId;
      var message_data = message.data;
      var action = message_data.action;

      var response_data; 
      switch(action) {
        case "addMeasurements":
          response_data = _addMeasurements(message_data);
          break;
      }
      
      response = {
        type: "response", 
        requestId: requestId, 
        success: true, 
        data: response_data
      };
      ws.send(JSON.stringify(response));
    }
  }
</script>
</head>

<body>
  <h3>Measurements</h3>
  <div id="measurements_output"></div>
</body>
</html>

